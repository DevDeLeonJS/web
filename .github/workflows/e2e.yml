name: E2E QA

on:
  pull_request:
    branches:
      - qa

jobs:
  e2e:
    name: Build app and run E2E
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repository
        uses: actions/checkout@v4

      - name: Ensure PR targets QA
        run: |
          if [ "${{ github.base_ref }}" != "qa" ]; then
            echo "Not a QA PR, skipping E2E"
            exit 0
          fi

      - name: Build and run app with Docker Compose
        run: |
          docker compose up -d --build

      - name: Wait for frontend
        run: |
          echo "Waiting for frontend..."
          for i in {1..20}; do
            if curl -f http://localhost:8080; then
              echo "Frontend is up"
              exit 0
            fi
            sleep 2
          done
          echo "Frontend did not start"
          exit 1

      - name: Clone E2E repository
        run: |
          git clone https://github.com/DevDeLeonJS/test-.git e2e

      - name: Install dependencies
        working-directory: e2e
        run: npm ci

      - name: Run Cypress tests
        working-directory: e2e
        env:
          CYPRESS_baseUrl: http://localhost:8080
        run: npx cypress run --browser chrome
